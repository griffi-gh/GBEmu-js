<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gameboy</title>
	<link rel="shortcut icon" href="/favicon.ico">
	<link rel="icon" type="image/png" href="/favicon.png">
	<link rel="stylesheet" href="/index.css">
	<script type="module">
		import {Gameboy} from './gb/gb.js';

		const $id = (i) => { return document.getElementById(i) };

		// https://stackoverflow.com/questions/10420352/converting-file-size-in-bytes-to-human-readable-string/10420404
		function humanFileSize(B,i){var e=i?1e3:1024;if(Math.abs(B)<e)return B+" B";var a=i?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],t=-1;do B/=e,++t;while(Math.abs(B)>=e&&t<a.length-1);return B.toFixed(1)+" "+a[t]}

		function button(id, fn) {
			const btn = document.getElementById(id);
			//btn.onclick = () => { fn(btn); };
			btn.addEventListener("click", () => { fn(btn); });
			btn.style.cssText += `width: ${(btn.getBoundingClientRect().width + 10).toString()}px;`;
			return btn;
		}
		function newGameboy() {
			return new Gameboy("gb-canvas");
		}

		window.addEventListener("load", function(){
			let gb = newGameboy();

			let btn_pause = button("btn-pause", (btn) => { 
				if(gb.paused) { gb.resume(); } else { gb.pause(); }
				btu();
				loop();
			});

			function btu() {
				btn_pause.textContent = gb.paused ? 'Play' : 'Pause';
			}

			button("btn-step", (btn) => {
				gb.step();
				loop();
			});

			button("btn-reset", (btn) => {
				gb.pause();
				console.clear(); 
				gb = newGameboy();
				const OK = 'OK!';
				let orig = btn.textContent;
				if(orig!==OK) {
					btn.textContent = OK;
					btn.classList.add("disabled");
					setTimeout(() => {
						btn.classList.remove("disabled");
						btn.innerHTML = orig;
					}, 1000)
				}
				btu();
				loop();
			});

			button("btn-log", (btn) => {
				gb.flushLog();
			});

			button("btn-dwn", (btn) => {
				gb.downloadLog();
			});

			button("btn-swlog", (btn) => {
				gb.disableLog ^= true;
				btn.innerHTML = gb.disableLog ? 'Enable logging' : 'Disable logging';
				if(gb.disableLog) { gb.logData = ''; }
				loop();
			});

			window.GB = gb

			function loop() {
				btu();
				const log = gb.logData;
				const emp = (log.length === 0);
				$id('log-size').innerHTML = humanFileSize(log.length, true);
				$id('log-line').innerHTML = log.split(/\r?\n/).at(-2);
				$id('log-info').style.display = (gb.disableLog || emp) ? 'none' : 'unset';
				$id('log-empty').style.display = (emp & (!gb.disableLog)) ? 'unset' : 'none';
				$id('log-disabled').style.display = gb.disableLog ? 'unset' : 'none';
			}
			setInterval(loop, 1000);
			loop();
		});

	</script>
</head>
<body>
	<div id="gb-wrapper"> 
		<canvas id="gb-canvas"></canvas>
		<div>
			<button id="btn-step"  class="button">Frame</button>
			<button id="btn-pause" class="button">Play</button>
			<button id="btn-reset" class="button">Reset</button>
		</div>
		<button id="btn-swlog" class="full button">Disable logging</button>
		<button id="btn-log" class="full button">Flush log to console</button>
		<button id="btn-dwn" class="full button">Flush log to file</button>
	</div>
	<br><br>
	<div id="log-info">
		<span class="lpart">Log size: </span><span id="log-size">Loading...</span><br>
		<span class="lpart">Last line: </span><span id="log-line">Loading...</span>
	</div>
	<div id="log-disabled"> 
		<span class="lpart red">Logging disabled</span>
	</div>
	<div id="log-empty"> 
		<span class="lpart yellow">Log empty</span>
	</div>
</body>
</html>